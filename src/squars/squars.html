<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head>

<title>Squars</title>
<meta http-equiv="Content-type" content="text/html; charset=UTF-8">
<meta name="description" content="LI7E!">
<style type="text/css" media="screen">
	
html, body { 
    margin: 0; 
    padding: 0; 
    height: 100%; 
    position: relative;
    overflow: auto;

    background-image: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#666666), to(#666666), color-stop(.6,#333));

    background-image: -moz-linear-gradient(25% 93% 334deg,#424242, #737373, #DEDEDE 100%);
    
}

#jcontainer
{
	margin-top:50px;
	
	margin-left:auto;
	margin-right:auto;
	width:630px;
	height: 500px;
	padding: 20px;
	background-color:#3B3B3B;

    	background-image: -webkit-gradient(
        	linear,
        	left bottom,
        	left top,
        	color-stop(0.06, rgb(0,0,0)),
        	color-stop(0.58, rgb(47,48,47))
    	);
    	background-image: -moz-linear-gradient(
        	center bottom,
        	rgb(0,0,0) 6%,
        	rgb(47,48,47) 58%
    	);
	
	box-shadow:4px 7px 10px #333333;
	border-radius:2em; 
	background-color: #030303; 
	color: #666666; 
        column-count:2; 
        column-gap:3em;
	text-align: center;
		
}

#squars
{
	border-radius:1em; background-color:#3B3B3B; padding:10px;
}

a {
	color: #fff;
}

#jdebug{
	 
}

/*
canvas {
	cursor:pointer;
}*/


</style>
<!--<script src="../jquery-1.3.2.min.js"></script>
<script src="squars/jquery.js"></script>
<script type="text/javascript" src="squars/mootools-core-1.js"></script>
<script type="text/javascript" src="squars/Audiolet.js"></script>
-->

   <!-- jquery UI -->
    <link type="text/css" href="../../vendor/jquery-ui-themes/ui-darkness/jquery-ui-1.8.9.custom.css" rel="stylesheet" />     
    <script type="text/javascript" src="../../vendor/jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="../../vendor/jquery-ui-1.8.13.custom.min.js"></script>

    <!-- audiolet -->
    <script type="text/javascript" src="../../vendor/Audiolet/src/mootools/mootools-core-1.3-full-nocompat.js"></script>
    <!-- <script type="text/javascript" src="../lib/audiolet/Audiolet.js"></script> -->
    <script type="text/javascript" src="../../vendor/Audiolet/src/audiolet/Audiolet.min.js"></script>

<script type="text/javascript">

// Configure this.
var flapLength = 16;
var padding = 6;
var fps = 15; // fastest fps to allow (to prevent less cpu usage)
var squarsWidth = 450; // Width of canvas
var color = true; // Use colours or Black + White
var rounded = true; // Use rounded corners?
var smoke = true;
var palette = false; // paletted colors or random
var pitchOffset = 0;


var browserwidth;
var browserheight;

var canvas;
var ctx;
var animation;
	
var outBounds;
var clicked = {pressed:false, out:false};
var oldd = new Date();

var flaps;
var gridwidth;

var elements= []; 
var padswitches = [];
var waves = []; // Push 'wave' particles here.


var interval = Math.round(1000/fps);
function init() {
		 canvas = document.getElementById('squars'); //$('#squars')[0]
		 canvas.width = canvas.style.width = squarsWidth;
		 canvas.height = canvas.style.height = squarsWidth;
		 canvas.onselectstart = function () { return false; }
		 
		 if (!canvas.getContext){ 
			 alert("Sorry, your browser does not support html 5 canvas. Please try with another browser!!");
			 return;
		 }
		 ctx = canvas.getContext("2d");
		 
		  // ie canvas.onmousedown = function () { return false; } // mozilla
		  
		 
		 var h = canvas.height;
		 gridwidth = (h - (flapLength+1)*padding)/flapLength;

		 var tx=0, ty=0,z =0;
		 for (var i1=0;i1<flapLength;i1++) {
			 tx=padding;
			 ty+=padding;
			 for (var i2=0;i2<flapLength;i2++) {
				 elements.push({x:Math.round(tx), y:Math.round(ty),
				 gx:i2, gy:i1, o:z});
							
				tx += gridwidth + padding;
				z++;
			 }
			 
			ty += gridwidth;
		 }
		 
		 paintGrids();
		 for (var i=0;i<flapLength*flapLength;i++) {
		 	 padswitches[i] = false;
		 }
}

var row=0;
function paintRow() {
	row++;
	row%=16;
	paintRow2(row);
	return false;
}

// Play with colors!
var strokeButtonBorder = "rgba(90,90,90,1)";
var fillClickedButton = "rgba(120,120,120,0.8)";
var fillUnclickedButton = "rgba(40,40,40,0.5)";
var fillBackground = "rgba(0,0,0,1)";
var fillHighlightColor = "rgba(256,256,256,1)"


// This paintRow function is called when Beat is made.
function paintRow2(row) {
	ctx.globalCompositeOperation = "source-over";
	var i,te;
	for (i=row; row<elements.length; i+= 16) {
		te = elements[i];
		
		// Show a bright highlight
		if (padswitches[te.o]) {
			ctx.fillStyle = fillHighlightColor;
			if (rounded) {
				 roundedRect(ctx,te.x,te.y,  gridwidth,gridwidth,5);
				 ctx.fill();
			} else {
				ctx.fillRect(te.x,te.y, gridwidth,gridwidth);
			}
			//alert(JSON.stringify(te));
			if (smoke) {
				waves.push({g:te.o, t:0});
			}
		} 
		 
	}
}

function roundedRect(ctx,x,y,width,height,radius){  
	ctx.beginPath();  
	ctx.moveTo(x,y+radius);  
	ctx.lineTo(x,y+height-radius);  
	ctx.quadraticCurveTo(x,y+height,x+radius,y+height);  
	ctx.lineTo(x+width-radius,y+height);  
	ctx.quadraticCurveTo(x+width,y+height,x+width,y+height-radius);  
	ctx.lineTo(x+width,y+radius);  
	ctx.quadraticCurveTo(x+width,y,x+width-radius,y);  
	ctx.lineTo(x+radius,y);  
	ctx.quadraticCurveTo(x,y,x,y+radius);  
} 

// Paint 1 square. 
function paintOneGrid(e) {
	var te;
	te = elements[e];
	ctx.globalCompositeOperation = "source-over";
	ctx.strokeStyle = strokeButtonBorder;
	if (rounded) {
		roundedRect(ctx,te.x,te.y,  gridwidth,gridwidth,5);
		ctx.stroke();
	} else {
		ctx.strokeRect(te.x,te.y, gridwidth,gridwidth);
	}
			
	 if (padswitches[te.o]) {
		ctx.fillStyle = fillClickedButton;
		if (rounded) {
	 	 	 roundedRect(ctx,te.x,te.y,  gridwidth,gridwidth,5);
	 	 	 ctx.fill();
	 	} else {
	 		ctx.fillRect(te.x,te.y, gridwidth,gridwidth);
	 	}
	 } else {
	 	 ctx.fillStyle = fillUnclickedButton;
	 	 if (rounded) {
	 	 	 roundedRect(ctx,te.x,te.y,  gridwidth,gridwidth,5);
	 	 	 ctx.fill();
	 	 } else {
	 	 	 ctx.fillRect(te.x,te.y, gridwidth,gridwidth);
	 	 }
	 	 
	 }
}


function paintGrids() {
	// Clear and paint background
	//ctx.clearRect(0,0,canvas.width,canvas.height);
	// It seems the source of inspiration came from http://tech.kayac.com/archive/canvas_background.html
	 
	ctx.globalCompositeOperation = "source-over";
	ctx.fillStyle = fillBackground;
	ctx.fillRect(0,0,canvas.width,canvas.height);
	
	
	 for (var e in elements) {
		 paintOneGrid(e);
	 }
	
	 if (smoke) {
		 ctx.globalCompositeOperation = "lighter";
		 
		 var ttl = 15;
		 var p,e; //partiripple
		 
		 for (w in waves) {
			 p = waves[w];
			 e = elements[p.g];
			 var r,g,b,a, l, d;
			 
			 
			 d = (ttl- p.t)/ttl; // amptitude based on decay 
						//- kind of lineaer (expr as fraction)
			 l  =  p.t * 25; // size of wave based on time.
			 
			 /*
			 // Non-linear particle animation
			 //d = Math.exp(-(ttl- p.t)/ttl) / Math.exp(1); // e^-x graph
			 //l = Math.exp(1) / Math.exp((ttl - p.t)/ttl) * 75;  // ln(x) graph
			  */
		 
			 
			 var ex=e.x+gridwidth/2, ey=e.y+gridwidth/2;
			 
			 var gradblur = ctx.createRadialGradient(ex, ey, 0, ex, ey, l);
			 ctx.beginPath();
			 
			 if (color) {
			 	 
			 	 if (palette) {
					 // Palette style
					 r = 255-42.5*e.gx;
					 g = 255-42.5*e.gy; //(flapLength- gy)
					 b = 5* p.t  ; //  255-	
				 } else { 
					 // random colors mutiplied by decay factor
					 r = (Math.random()*255) *  d * 1.8;
					 g = (Math.random()*255) *  d * 1.8;
					 b = (Math.random()*255) *  d * 1.8;
					 // note *1 gives a little unsaturated colors
					 // but *2 creates too much white outs
					 // probably a sine curve can normalize the values
				 }
				 
				 r = r >> 0;
				 g = g >> 0;
				 b = b >> 0;
				 
				 a =1; // alpha

			 } else {
				 r = g= b= Math.round( d *    100);
				 a =1 ;
			 }
			 
			  
			var edgecolor1 = "rgba(" + r + "," + g + "," + b + ",0.45)";
			var edgecolor2 = "rgba("  + r + "," + g + "," + b + ",0.3)";
			var edgecolor3 = "rgba("  + r + "," + g + "," + b +",0.15)";
			var edgecolor4 = "rgba(" + r + "," + g + "," + b + ",0)";
			
			
			gradblur.addColorStop(0,edgecolor4);

			gradblur.addColorStop(0.15,edgecolor3);
			gradblur.addColorStop(0.3,edgecolor2);
			gradblur.addColorStop(0.5,edgecolor1);
			gradblur.addColorStop(0.7,edgecolor2);
			gradblur.addColorStop(0.85,edgecolor3);
			gradblur.addColorStop(1,edgecolor4);
				
			    
			    
			ctx.fillStyle = gradblur;
			ctx.arc(ex, ey, l, 0, Math.PI*2, false);
			ctx.fill();
			
			
			p.t++;
			if (p.t>ttl) {
				waves.splice(w,1);
			}
			 
		 }
	 }
	 // $('#jdebug').html(JSON.stringify(elements));  
	 
	 
	
}
	
// Render Ripple..
function ripple() {
	paintGrids();
	return false;
}

function getGrid(x,y) {
	var te;
	for (var e in elements) {
			 te = elements[e];
			 if (te.x <= x && 
				 x <= (te.x+gridwidth) && 
				te.y <= y &&
			y <= (te.y+gridwidth)) {
		 return te;
		}
			 
	 }
	 
	 return null;
}


function toggleGrid(x,y) {
	var clickgrid;
	if (clickgrid = getGrid(x,y)) {

		  //$('#jdebug').html(x+" "+y + 
			//  JSON.stringify(getGrid(x,y)));
		   if (clicked.lastGrid && (clickgrid.gx==clicked.lastGrid.gx)
				&&(clickgrid.gy==clicked.lastGrid.gy)) {
				 // Still on the last grid
			} else {// BUGGY!
				if (clicked.toggle==null ) {
					clicked.toggle = !padswitches[clickgrid.o];
				}
				
				
				if (clicked.toggle != padswitches[clickgrid.o]){
					// Call AS3
					if (!$('#sionProject')[0].as_toggle) {
						$('#jdebug').html("Error, flash bridge is not loaded");
					}
					var ret = $('#sionProject')[0].as_toggle(clickgrid.gx, clickgrid.gy);
					
					//$('#jdebug').html(clicked.toggle+" " +padswitches[clickgrid.o]);
					
					padswitches[clickgrid.o]= clicked.toggle;
					paintOneGrid(clickgrid.o);
				  
					clicked.lastGrid = clickgrid;
				  
				 
				}
			}
		  
		 
	} else {
		clicked.lastGrid = null;
		//$('#jdebug').html("no hit"); 
	}
}


// Options Setters

// Clear grids 
function clearClicks() {
	/*
	var ee;
	for (var e in elements) {
		ee = elements[e];
		if (padswitches[ee.o]) {
			var ret = $('#sionProject')[0].as_toggle(ee.gx, ee.gy);
			// we should use a single clear all call to AS
		}		
	 } */
	$('#sionProject')[0].as_clearall();
	padswitches = [];
	paintGrids();
}

function toggleColor(v) {
	color = v;
}

function toggleRounded(v) {
	rounded = v;
}

function toggleSmoke(v) {
	smoke = v;
}

function toggleRandom(v) {
	palette = !v;
}

function pitchUp() {
	pitchOffset ++;
	$('#sionProject')[0].as_pitch(pitchOffset);
}

function pitchDown() {
	pitchOffset --;
	$('#sionProject')[0].as_pitch(pitchOffset);
}


// Color graidents? Google T shirt?
$(document).ready(function(){
	init();
	/*
	$(window).bind('resize',function(e) {
			initNav();
	});
	*/
	
	
	$(canvas).mousedown(function(e) {
		var x = e.pageX - $(this).offset().left;
		var y = e.pageY - $(this).offset().top  ;
		
		// Check if clicked
		clicked.pressed = true;
		toggleGrid(x,y);
	}).mouseup(function(e) {
		clicked.pressed = false;
		clicked.out = false;
		clicked.x = 0;
		clicked.y = 0;
		clicked.lastGrid = null;
		clicked.toggle = null;
				
		//$('#jdebug').html("mouseup"); 
	}).mousemove(function(e) {
	/* 
	
		var newd = new Date();
		if ((newd.getTime()-oldd.getTime())<interval) {
			return ;
			// this prevents using too much cpu cycles
		}	
		oldd = newd;
		*/
		
		
		var x = e.pageX - $(this).offset().left ;
		var y = e.pageY - $(this).offset().top ;
		
		//$('#jdebug').html(x+" "+y + getGrid(x,y));
		
		if (clicked.out && !outBounds) {				
			//$('#jdebug').html("in and dragged" + clicked.out + "outBounds"+outBounds);
			clicked.pressed = true;
			clicked.out = false
			
		} else if (clicked.pressed && outBounds){
			clicked.pressed = false;
			clicked.out = true;
			//$('#jdebug').html("stop drag");
		}
		
		if (clicked.pressed) {
			toggleGrid(x,y);
			
		} else {
		
			if (getGrid(x,y)!=null) {
				// If mouse over draggable box change cursor
				$('body').css({cursor:'pointer'}); // Or move
			} else {
				$('body').css({cursor:'auto'}); //#squars
			}
		}
		
		
	}).mouseout(function(e) {
		
		if (clicked.pressed) clicked.out = true;
		clicked.pressed = false;
		
	}).mouseenter(function(e) {
		
		if (clicked.out) {
			clicked.pressed = true;
			clicked.out = false;
		}
		
	});
	
	//animation = setInterval(ripple, interval);                            

});


function initDim(){
	/* Do not touch*/
	browserwidth = $(window).width();
	browserheight = $(window).height();
	
}

function play(){
	//$('#sionProject')[0].as_pitch(15);
	if (!animation) {
		animation = setInterval(ripple, interval);
		//animationStarted=  true;
	}
	$('#sionProject')[0].as_play();
	
}

function stop() {
	$('#sionProject')[0].as_shutup();
	if (animation) {
		clearInterval(animation);
		//animationStarted = false;
		animation = null;
	}
	
}

var swfCallback = function(e) { 
	$('#jdebug').append( e.success ? 'Loading...':'Not loaded');

}
</script>
</head>

<body style="cursor: auto;">


<div id="jcontainer" >

<div style="float:left;">

	<input onclick="play();" value="Play" type="button">&nbsp;<br> <br>
	<input onclick="stop();" value="Stop" type="button">&nbsp;<br> <br>
	<input onclick="clearClicks();" value="Clear All" type="button">&nbsp;<br> <br>

			
	<input onclick="toggleRounded(this.checked);" checked="checked" type="checkbox">Rounded&nbsp;<br>
	<input onclick="toggleSmoke(this.checked);" checked="checked" type="checkbox">Smokes&nbsp;<br>
	<input onclick="toggleColor(this.checked);" checked="checked" type="checkbox">Colours&nbsp;<br>
	<input onclick="toggleRandom(this.checked);" checked="checked" type="checkbox">Random Colours&nbsp;<br>

	
	<br><br><br><br>
</div>

<canvas style="float:right;" id="squars" width="450" height="450"></canvas>

	<div id="jdebug">Debug</div>

</div> 


<script type="text/javascript"> 

// Audiolet


    var majorScale = [ 261.63, 293.66, 329.63, 349.23, 392, 440, 493.88, 523.25];

    var audiolet = new Audiolet();

    audiolet.scheduler.setTempo(120);

    // creating an instrument

    // borrowed from @o_amp_o's code
    var HighSynth = new Class({
        Extends: AudioletGroup,
        initialize: function(audiolet) {
            AudioletGroup.prototype.initialize.apply(this, [audiolet, 0, 1]);
           
            // Triangle base oscillator
            this.triangle = new Triangle(audiolet);

            // Note on trigger
            this.trigger = new TriggerControl(audiolet);

            // Gain envelope
            this.gainEnv = new PercussiveEnvelope(audiolet, 0, 0.2, 0.2);
            this.gainEnvMulAdd = new MulAdd(audiolet, 0.3);
            this.gain = new Gain(audiolet);

            // Connect oscillator
            this.triangle.connect(this.gain);
            
            // Connect trigger and envelope
            this.trigger.connect(this.gainEnv);
            this.gainEnv.connect(this.gainEnvMulAdd);
            this.gainEnvMulAdd.connect(this.gain, 0, 1);
            this.gain.connect(this.outputs[0]);
        }
    });

    var synths = [];
    var patterns = [];

    var duration = new PProxy(new PSequence([1], Infinity));

    for (i=0; i<8; i++) {
        synths[i] = new HighSynth(audiolet)
        synths[i].connect(audiolet.output);
        patterns[i] = new PProxy(new PSequence([0, 0, 0, 0, 0, 0, 0, 0], Infinity));
        audiolet.scheduler.play([patterns[i]], duration,
                                function (frequency) {
                                    this.trigger.trigger.setValue(1);
                                    this.triangle.frequency.setValue(frequency);
                                }.bind(synths[i]));
    }
	

</script> 	
	
<script type="text/javascript"> 
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="squars/ga.js" type="text/javascript"></script> 
<script type="text/javascript"> 
try {
var pageTracker = _gat._getTracker("UA-7549263-1");
pageTracker._trackPageview();
} catch(err) {}
</script> 

</body></html>
